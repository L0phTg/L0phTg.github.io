<!DOCTYPE html>
<html lang="">
<head>

  <meta charset="utf-8" />

  
  <title>InlineHook学习分析</title>

  
  
  
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  
  <link href="//at.alicdn.com" rel="dns-prefetch">
  
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  
  
  
  
  

  

  
  <meta name="author" content="L0phTg">
  <meta name="description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.
">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="InlineHook学习分析">
    <meta name="twitter:description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.
">
    <meta name="twitter:image" content="/images/avatar.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="InlineHook学习分析">
  <meta property="og:description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.
">
  <meta property="og:url" content="http://L0phTg.top/post/inlinehook%E5%AD%A6%E4%B9%A0%E5%88%86%E6%9E%90/">
  <meta property="og:image" content="/images/avatar.png">






<link rel="canonical" href="http://L0phTg.top/post/inlinehook%E5%AD%A6%E4%B9%A0%E5%88%86%E6%9E%90/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="L0phTg&#39;s Blog">
<meta name="msapplication-tooltip" content="L0phTg&#39;s Blog">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="/icons/icon-152x152.png">
<link rel="manifest" href="/manifest.json">


<link rel="preload" href="/styles/main-rendered.min.css" as="style">


<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/images/avatar.png" as="image">
<link rel="preload" href="/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/styles/main-rendered.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">




<link rel="stylesheet" href="/css/styles/dracula.css">




  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


  

  <script src="/js/highlight.pack.js"></script>


<script>hljs.initHighlightingOnLoad();</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script> mermaid.initialize({ startOnLoad: true });</script>

</head>
  <body>
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
      
    </div>
    
    
    
  
  <header class="site-header">
  <a href="http://L0phTg.top/"><img class="avatar" src="/images/avatar.png" alt="Avatar"></a>
  
  <h2 class="title"><a href="http://L0phTg.top/">L0phTg&#39;s Blog</a></h2>
  
  <p class="subtitle">~  读万卷书 &amp; 行万里路 ~</p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="/post/">Archives</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </nav>
 
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">InlineHook学习分析</h1>
      <p class="post-meta">@L0phTg · Apr 5, 2018 · 11 min read</p>
      
    </header>
     
     
<div class="post-toc" id="post-toc">
  
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#参考文章和项目代码">参考文章和项目代码</a></li>
    <li><a href="#使用方法">使用方法</a></li>
    <li><a href="#分析">分析</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>

     
    <article class="post-content"><p>分析开源的inlineHook代码, 总结inlineHook的原理与实现.</p>
<p>本文首发于<strong>看雪论坛</strong>, 转载请注明出处.</p>
<h2 id="前言">前言</h2>
<p>最近在面试某大厂的安全岗位时，面试官问到了一些有关hook的知识, 在简单分析了下F8大牛的开源代码之后, 有了这篇文章.</p>
<h2 id="参考文章和项目代码">参考文章和项目代码</h2>
<p>文章:</p>
<p><a href="http://ele7enxxh.com/Android-Arm-Inline-Hook.html">http://ele7enxxh.com/Android-Arm-Inline-Hook.html</a></p>
<p><a href="http://gslab.qq.com/portal.php?mod=view&amp;aid=168">http://gslab.qq.com/portal.php?mod=view&amp;aid=168</a></p>
<p>项目:</p>
<p><a href="https://github.com/ele7enxxh/Android-Inline-Hook">https://github.com/ele7enxxh/Android-Inline-Hook</a></p>
<p><a href="https://github.com/F8LEFT/FAInHook">https://github.com/F8LEFT/FAInHook</a></p>
<h2 id="使用方法">使用方法</h2>
<p>MainActivity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">loadLibrary</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;FHook&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">native</span> String <span style="color:#a6e22e">stringFromJNI</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>我们会将会测试Hook 这个&quot;stringFromJNI()&ldquo;函数.</p>
<h2 id="分析">分析</h2>
<h4 id="使用">使用</h4>
<p>在native层, 我们的main.cpp中</p>
<p>会在JNI_OnLoad中有一个init函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>jstring <span style="color:#a6e22e">stringFromJNI</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        JNIEnv <span style="color:#f92672">*</span>env<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        jobject <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     doInHook<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// doGotHook();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> env<span style="color:#f92672">-&gt;</span>NewStringUTF<span style="color:#f92672">(</span>getStr<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JNIEXPORT jint JNICALL <span style="color:#a6e22e">JNI_OnLoad</span><span style="color:#f92672">(</span>JavaVM<span style="color:#f92672">*</span> vm<span style="color:#f92672">,</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>reserved<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    JNIEnv<span style="color:#f92672">*</span> env <span style="color:#f92672">=</span> nullptr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    jint resultstr <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>vm<span style="color:#f92672">-&gt;</span>GetEnv<span style="color:#f92672">((</span><span style="color:#66d9ef">void</span> <span style="color:#f92672">**)</span> <span style="color:#f92672">&amp;</span>env<span style="color:#f92672">,</span> JNI_VERSION_1_6<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> JNI_OK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    auto jclazz <span style="color:#f92672">=</span> env<span style="color:#f92672">-&gt;</span>FindClass<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com/example/l0phtg/hookstudyf8/MainActivity&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    JNINativeMethod natives<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;stringFromJNI&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;()Ljava/lang/String;&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">void</span><span style="color:#f92672">*)</span>stringFromJNI<span style="color:#f92672">}};</span>
</span></span><span style="display:flex;"><span>    env<span style="color:#f92672">-&gt;</span>RegisterNatives<span style="color:#f92672">(</span>jclazz<span style="color:#f92672">,</span> natives<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    env<span style="color:#f92672">-&gt;</span>DeleteLocalRef<span style="color:#f92672">(</span>jclazz<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    init<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> JNI_VERSION_1_6<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在Hook.cpp我们来看一下init函数:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> hook <span style="color:#f92672">=</span> FAInHook<span style="color:#f92672">::</span>instance();
</span></span><span style="display:flex;"><span>    hook<span style="color:#f92672">-&gt;</span>registerHook((Elf_Addr)getStr,
</span></span><span style="display:flex;"><span>                       (Elf_Addr)inlCallback,
</span></span><span style="display:flex;"><span>                       (Elf_Addr<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>inlCallbackSrc);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> lib <span style="color:#f92672">=</span> dlopen(<span style="color:#e6db74">&#34;libFHook.so&#34;</span>, RTLD_NOW);
</span></span><span style="display:flex;"><span>    gotCallbackSrc <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> (<span style="color:#f92672">*</span>)())dlsym(lib, <span style="color:#e6db74">&#34;_Z6getStrv&#34;</span>);
</span></span><span style="display:flex;"><span>    dlclose(lib);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到, 我们实例化了一个FAInHook对象, <code>new FAInHook()</code>.</p>
<p>并调用了<code>registerHook</code>函数来注册对getStr的hook.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAInHook <span style="color:#f92672">*</span>FAInHook<span style="color:#f92672">::</span>instance() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> FAInHook<span style="color:#f92672">*</span> mIns <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(mIns <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        mIns <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAInHook();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> mIns;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们在使用是还会用到的<code>doInHook</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">doInHook</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> isHooked <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isHooked) {
</span></span><span style="display:flex;"><span>        isHooked <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        FAInHook<span style="color:#f92672">::</span><span style="color:#a6e22e">instance</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">unhookAll</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        isHooked <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        FAInHook<span style="color:#f92672">::</span><span style="color:#a6e22e">instance</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">hookAll</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>现在可以看到, 我们主要的任务就是分析<code>registerHook</code>和<code>doInHook</code>这两个函数的实现.</strong></p>
<h4 id="registerhook函数">registerHook函数</h4>
<p>我们现在主要分析<code>registerHook</code>函数.</p>
<p>先来分析参数:
在Hook之前我们首先要注册这个函数</p>
<p>函数申明:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    HOOK_STATUS <span style="color:#a6e22e">registerHook</span>(Elf_Addr orginalFunAddr, Elf_Addr newFunAddr,
</span></span><span style="display:flex;"><span>                             Elf_Addr<span style="color:#f92672">*</span> callOrigin);
</span></span></code></pre></div><p>参数(原始函数地址, 新函数地址, 调用原始函数).</p>
<p>函数主要流程:</p>
<ol>
<li>
<p>注册函数信息, 计算hook stub.</p>
<p>首先判断<code>originFunAddr</code>和<code>newFunAddr</code>是否是函数地址.</p>
<p>auto info = getHookInfo(originFunAddr); 得到函数信息</p>
<p>然后判断函数是否已经被Hook.</p>
</li>
<li>
<p>检查判断指令类型(thumb or arm or x86 &hellip;)</p>
</li>
<li>
<p>createStub(info)     创建stub, 就是thumb下创建ldr.w pc, [pc],   addr 来执行跳转到newFuncAddr功能</p>
</li>
<li>
<p>createCallOriginalStub(info) 创建originalFunAddr的stub, 主要会涉及一些对pc相关指令的处理.</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">//  register hook
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FAInHook<span style="color:#f92672">::</span>HOOK_STATUS FAInHook<span style="color:#f92672">::</span>registerHook(
</span></span><span style="display:flex;"><span>        Elf_Addr orginalFunAddr, Elf_Addr newFunAddr, Elf_Addr <span style="color:#f92672">*</span>callOrigin) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// register hook information, calc hook stub at the same time.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>FAHook<span style="color:#f92672">::</span>MemHelper<span style="color:#f92672">::</span>isFunctionAddr((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) orginalFunAddr)
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>FAHook<span style="color:#f92672">::</span>MemHelper<span style="color:#f92672">::</span>isFunctionAddr((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) newFunAddr)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FERROR_NOT_EXECUTABLE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> info <span style="color:#f92672">=</span> getHookInfo(orginalFunAddr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">nullptr</span> <span style="color:#f92672">!=</span> info) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> hookStatus <span style="color:#f92672">=</span> info<span style="color:#f92672">-&gt;</span>getHookStatus();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(FAHook<span style="color:#f92672">::</span>HOOKED <span style="color:#f92672">==</span> hookStatus) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FERROR_ALREADY_HOOKED;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(FAHook<span style="color:#f92672">::</span>REGISTERED <span style="color:#f92672">==</span> hookStatus) {
</span></span><span style="display:flex;"><span>            delHookInfo(info);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// check for FunctionType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> type <span style="color:#f92672">=</span> FAHook<span style="color:#f92672">::</span>Instruction<span style="color:#f92672">::</span>getFunctionType(orginalFunAddr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(FAHook<span style="color:#f92672">::</span>ERRTYPE <span style="color:#f92672">==</span> type) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FERROR_UNKNOWN;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    info <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>HookInfo((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) orginalFunAddr, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) newFunAddr);
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>setOriginalFunctionType(type);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FAHook<span style="color:#f92672">::</span>Instruction<span style="color:#f92672">*</span> instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(type) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(__arm__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>ARM:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>ArmInstruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>THUMB:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>ThumbInstruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__aarch64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>ARM64:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>Arm64Instruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__i386__) || defined(__x86_64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>X86:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>X64:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>IntelInstruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__mips64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>MIPS64:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>Mips64Instruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__mips__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> FAHook<span style="color:#f92672">::</span>MIPS:
</span></span><span style="display:flex;"><span>            instruction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FAHook<span style="color:#f92672">::</span>MipsInstruction();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            assert(false <span style="color:#f92672">&amp;&amp;</span> <span style="color:#e6db74">&#34;not support abi&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FERROR_UNKNOWN;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>instruction<span style="color:#f92672">-&gt;</span>createStub(info)
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>instruction<span style="color:#f92672">-&gt;</span>createBackStub(info)
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> (callOrigin <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">!</span>instruction<span style="color:#f92672">-&gt;</span>createCallOriginalStub(info) <span style="color:#f92672">:</span> false  <span style="color:#75715e">// want a callback
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> instruction;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> info;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FERROR_MEMORY;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    addHookInfo(info);
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>setHookStatus(FAHook<span style="color:#f92672">::</span>REGISTERED);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(callOrigin <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>callOrigin <span style="color:#f92672">=</span> (Elf_Addr) info<span style="color:#f92672">-&gt;</span>getCallOriginalIns();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span> instruction;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FERROR_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="判断该地址是否是函数地址">判断该地址是否是函数地址</h5>
<ol>
<li>打开<code>/proc/self/maps</code>， 读取每行的信息, 用strstr根据权限做出判断.(r-x, 表示可读可执行, 即为code)()</li>
<li>addr &gt;= startAddr &amp;&amp; addr &lt;= endAddr</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAHook<span style="color:#f92672">::</span>MemHelper<span style="color:#f92672">::</span><span style="color:#a6e22e">isFunctionAddr</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[MAX_BUF];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(maps, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(nullptr <span style="color:#f92672">==</span> fp) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#a6e22e">fgets</span>(buf, MAX_BUF, fp)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strstr</span>(buf, <span style="color:#e6db74">&#34;r-xp&#34;</span>) <span style="color:#f92672">!=</span> nullptr) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> startAddr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">strtoul</span>(<span style="color:#a6e22e">strtok</span>(buf, <span style="color:#e6db74">&#34;-&#34;</span>), nullptr, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> endAddr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">strtoul</span>(<span style="color:#a6e22e">strtok</span>(nullptr, <span style="color:#e6db74">&#34; &#34;</span>), nullptr, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(addr <span style="color:#f92672">&gt;=</span> startAddr <span style="color:#f92672">&amp;&amp;</span> addr <span style="color:#f92672">&lt;=</span> endAddr) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FLOGE</span>(this functionAddr is not a function<span style="color:#f92672">!</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="得到hook地址的信息-是否已经hook">得到Hook地址的信息, 是否已经Hook.</h5>
<p>hook_map是一个std::map&lt;Elf_Addr, FAInHook::HookInfo*&gt;的map类型. find函数会返回返回一个迭代器, 可以用<code>it-&gt;first</code>和<code>it-&gt;second</code>来访问它的成员(key和value). 这个过程其实对已经注册过的hook函数的处理.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>FAHook<span style="color:#f92672">::</span>HookInfo <span style="color:#f92672">*</span>FAInHook<span style="color:#f92672">::</span><span style="color:#a6e22e">getHookInfo</span>(Elf_Addr origFunAddr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> hook_map.<span style="color:#a6e22e">find</span>(origFunAddr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(it <span style="color:#f92672">==</span> hook_map.<span style="color:#a6e22e">end</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> nullptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> it<span style="color:#f92672">-&gt;</span>second;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="得到originlfunaddr的指令类型">得到originlFunAddr的指令类型,</h5>
<p>auto type = FAHook::Instruction::getFunctionType(orginalFunAddr);</p>
<p>下面是<code>getFunctionAddr</code>的实现, 可以看到. 判断指令类型的方式, 是通过自己定义宏来实现的. 当然, 在Arm指令中, 我们还要是否该指令为thumb指令.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> FunctionType <span style="color:#a6e22e">getFunctionType</span>(Elf_Addr functionAddr) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(__arm__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">0</span> <span style="color:#f92672">==</span> functionAddr) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> ERRTYPE;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>((functionAddr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> ARM;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> THUMB;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__aarch64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> ARM64;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__i386__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> X86;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__x86_64__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> X64;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__mips64__)  </span><span style="color:#75715e">/* mips64el-* toolchain defines __mips__ too */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> MIPS64;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__mips__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> MIPS;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span></code></pre></div><h5 id="接下来-我们分析最重要的过程">接下来, 我们分析最重要的过程:</h5>
<ol>
<li>info = new HookInfo(originFunAddr, newFunAddr);</li>
<li>info.setOriginalFunctionType(type);   设置指令类型为(Arm或者thumb)</li>
<li>instruction = new FAHook::ArmInstruction();        new arm或者thumb指令. 我发现无构造函数.</li>
<li>instruction-&gt;createStub(info);        创建stub.(stub为 jump stub来jump到newFuncAddr)</li>
<li>instruction-&gt;createCallOriginalStub(info)    创建原函数的call back stub.</li>
</ol>
<p>在看<code>HookInfo.h</code>时, 我们可以看到<code>FAHook</code>是一个<code>namespace</code>, 而里面主要包含了一个<code>HookInfo</code>的类:</p>
<p>我们先来分析它的构造函数:</p>
<p>这里运用了c++中的构造函数初始化列表来初始化类成员.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">HookInfo</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> originalAddr, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> hookAddr)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> <span style="color:#a6e22e">original_addr_</span>(originalAddr), <span style="color:#a6e22e">hook_addr_</span>(hookAddr),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">original_stub_back_</span>(nullptr), <span style="color:#a6e22e">back_len_</span>(<span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">call_original_ins_</span>(nullptr),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">hook_status_</span>(ERRSTATUS),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">original_function_type_</span>(ERRTYPE), <span style="color:#a6e22e">hook_function_type_</span>(ERRTYPE){}
</span></span><span style="display:flex;"><span>        
</span></span></code></pre></div><p>分析<code>createStub(info)</code>
我们这里分析<code>FAHook::ThumbInstrution::createStub(FAHook::HookInfo *info)</code>:</p>
<ol>
<li>将地址按4字节对齐.</li>
<li>保存我们的stub指令, (方便之后path)指令为: <code>LDR.W PC, [PC]</code>. 可参考(<a href="http://ele7enxxh.com/Android-Arm-Inline-Hook.html)">http://ele7enxxh.com/Android-Arm-Inline-Hook.html)</a>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAHook<span style="color:#f92672">::</span>ThumbInstruction<span style="color:#f92672">::</span><span style="color:#a6e22e">createStub</span>(FAHook<span style="color:#f92672">::</span>HookInfo <span style="color:#f92672">*</span>info) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> stubSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>stub <span style="color:#f92672">=</span> nullptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> addr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getOriginalAddr</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> clearBit0 <span style="color:#f92672">=</span> addr <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (clearBit0 <span style="color:#f92672">%</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {                       <span style="color:#75715e">// need to align 4, just patch with nop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        stub <span style="color:#f92672">=</span> new <span style="color:#66d9ef">uint8_t</span>[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>        ((<span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">*</span>)stub)[stubSize<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xBF00</span>;     <span style="color:#75715e">//NOP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        stub <span style="color:#f92672">=</span> new <span style="color:#66d9ef">uint8_t</span>[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">*</span>)stub)[stubSize<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xF8DF</span>;
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">*</span>)stub)[stubSize<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xF000</span>; <span style="color:#75715e">// LDR.W PC, [PC]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ((<span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">*</span>)stub)[stubSize<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHookAddr</span>() <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFF</span>;
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">uint16_t</span><span style="color:#f92672">*</span>)stub)[stubSize<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHookAddr</span>() <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setJumpStubLen</span>(stubSize <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setJumpStubBack</span>(stub);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="下面分析-createcalloriginalstubhookinfo-info">下面分析 <code>createCallOriginalStub(HookInfo *info)</code>:</h5>
<p>thumbInstruction.cpp的实现:</p>
<p>基础知识:</p>
<p>reinterpret_cast&lt;uint16_t*&gt;   为类型转换</p>
<ol>
<li>处理ldr.w指令.</li>
<li>调用createExecMemory(length);              // 分配buffer空间</li>
<li>修正pc相关指令. (ldr liternal.  b.  b.  bl.  cbz. ldrw. add)</li>
</ol>
<p><code>为什么要修正pc相关指令?</code></p>
<p>举例分析: b <!-- raw HTML omitted -->:</p>
<p>指令编码分析: [15:12] 1101 [11:8] cond [7:0] imm8</p>
<p>解析时:</p>
<ul>
<li>
<p>imm32 = ZeroExtend(imm8:&lsquo;0&rsquo;, 32);</p>
</li>
<li>
<p>BranchWritePC(PC+imm32)</p>
</li>
</ul>
<p>可以看到, b指令的指令编码中, 存放的立即数为imm8, 而真实的跳转地址为(pc + imm32).
由于我们是要inlineHook, 所以我们的hook函数执行完成之后还有继续执行我们原来的函数,那么我们就要执行被patch掉的那些指令（我们已经将这些指令保存了下来），但由于存放这些指令的内存是我们mmap出来的,所以我们 要想能够在这里成功运行pc相关指令的话, 我们需要将pc相关的指令转换为其它pc无关的指令。</p>
<p>inlineHook原理图, 来源于gslab.</p>
<p><img src="http://gslab.qq.com/data/attachment/portal/201605/04/165921tz43a3sm4vi2s4s4.png" alt="inlineHook原理图 &amp;mdash;  来源于gslab"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAHook<span style="color:#f92672">::</span>ThumbInstruction<span style="color:#f92672">::</span>createCallOriginalStub(FAHook<span style="color:#f92672">::</span>HookInfo <span style="color:#f92672">*</span>info) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">area</span>(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*&gt;</span>(getOriginalAddr(info)));    <span style="color:#75715e">// 起始地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">trail</span>(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*&gt;</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>uintptr_t <span style="color:#f92672">&gt;</span>(area) <span style="color:#f92672">+</span> info<span style="color:#f92672">-&gt;</span>getJumpStubLen())); <span style="color:#75715e">// 结束地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>ldrw(area[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&amp;&amp;</span>  <span style="color:#75715e">// 第一条指令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        area[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xF000</span>   <span style="color:#75715e">// 判断第一条指令是否为 ldr pc, [pc]  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">arm</span>(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*&gt;</span>(area));
</span></span><span style="display:flex;"><span>        info<span style="color:#f92672">-&gt;</span>setCallOriginalIns(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*&gt;</span>(arm[<span style="color:#ae81ff">1</span>]));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">required</span>((trail <span style="color:#f92672">-</span> area) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>)); <span style="color:#75715e">// required == 需要patch多少字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">used</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (used <span style="color:#f92672">&lt;</span> required)
</span></span><span style="display:flex;"><span>        used <span style="color:#f92672">+=</span> MSGetInstructionWidthThumb(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*&gt;</span>(area) <span style="color:#f92672">+</span> used);
</span></span><span style="display:flex;"><span>    used <span style="color:#f92672">=</span> (used <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">blank</span>((used <span style="color:#f92672">-</span> required) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> backup[used <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>)];
</span></span><span style="display:flex;"><span>    memcpy(backup, area, used);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">length</span>(used);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> offset(<span style="color:#ae81ff">0</span>); offset <span style="color:#f92672">!=</span> used <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>); <span style="color:#f92672">++</span>offset)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>ldr(backup[offset]))
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>b(backup[offset]))
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T2<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>b(backup <span style="color:#f92672">+</span> offset)) {
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>bl(backup <span style="color:#f92672">+</span> offset)) {
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>cbz(backup[offset])) {
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>ldrw(backup[offset])) {
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>add(backup[offset]))
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">+=</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">32</span>bit<span style="color:#960050;background-color:#1e0010">$</span>i(backup[offset]))
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">unsigned</span> <span style="color:#a6e22e">pad</span>((length <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x2</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">+=</span> (pad <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint32_t</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span>buffer <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span>) MemHelper<span style="color:#f92672">::</span>createExecMemory(length);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(buffer <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size_t <span style="color:#a6e22e">start</span>(pad), end(length <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">trailer</span>(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*&gt;</span>(buffer <span style="color:#f92672">+</span> end));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> offset(<span style="color:#ae81ff">0</span>); offset <span style="color:#f92672">!=</span> used <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>); <span style="color:#f92672">++</span>offset) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>ldr(backup[offset])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> immediate : <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> rd : <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>pc_im_4<span style="color:#960050;background-color:#1e0010">$</span>(bits.rd, T<span style="color:#960050;background-color:#1e0010">$</span>Label(start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>, end<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>rn_im_4<span style="color:#960050;background-color:#1e0010">$</span>(bits.rd, bits.rd, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// XXX: this code &#34;works&#34;, but is &#34;wrong&#34;: the mechanism is more complex than this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span><span style="color:#ae81ff">0x2</span>) <span style="color:#f92672">+</span> bits.immediate <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>b(backup[offset])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> imm8 : <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> cond : <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#75715e">/*1101*/</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            intptr_t jump(bits.imm8 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>b<span style="color:#960050;background-color:#1e0010">$</span>_<span style="color:#960050;background-color:#1e0010">$</span>im(bits.cond, (end<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span> <span style="color:#f92672">-</span> (start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> jump;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> A<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(A<span style="color:#960050;background-color:#1e0010">$</span>pc, A<span style="color:#960050;background-color:#1e0010">$</span>pc, <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>nop <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span> T<span style="color:#960050;background-color:#1e0010">$</span>bx(A<span style="color:#960050;background-color:#1e0010">$</span>pc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T2<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>b(backup <span style="color:#f92672">+</span> offset)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> imm6 : <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> cond : <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> s : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> imm11 : <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> j2 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> a : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> j1 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } exts <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            intptr_t jump(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> exts.imm11 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> bits.imm6 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (exts.a) {
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> bits.s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> (<span style="color:#f92672">~</span>(bits.s <span style="color:#f92672">^</span> exts.j1) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> (<span style="color:#f92672">~</span>(bits.s <span style="color:#f92672">^</span> exts.j2) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">22</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> bits.cond <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">18</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> bits.s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> exts.j2 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">19</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">|=</span> exts.j1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">18</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>                jump <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>b<span style="color:#960050;background-color:#1e0010">$</span>_<span style="color:#960050;background-color:#1e0010">$</span>im(exts.a <span style="color:#f92672">?</span> A<span style="color:#960050;background-color:#1e0010">$</span>al : bits.cond, (end<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span> <span style="color:#f92672">-</span> (start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> jump;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> A<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(A<span style="color:#960050;background-color:#1e0010">$</span>pc, A<span style="color:#960050;background-color:#1e0010">$</span>pc, <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>nop <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span> T<span style="color:#960050;background-color:#1e0010">$</span>bx(A<span style="color:#960050;background-color:#1e0010">$</span>pc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>bl(backup <span style="color:#f92672">+</span> offset)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> immediate : <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> s : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> immediate : <span style="color:#ae81ff">11</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> j2 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> x : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> j1 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } exts <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int32_t</span> jump(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> bits.s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> (<span style="color:#f92672">~</span>(bits.s <span style="color:#f92672">^</span> exts.j1) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> (<span style="color:#f92672">~</span>(bits.s <span style="color:#f92672">^</span> exts.j2) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">22</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> bits.immediate <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> exts.immediate <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> exts.x;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>push_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> A<span style="color:#960050;background-color:#1e0010">$</span>r7);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>pc_im_4<span style="color:#960050;background-color:#1e0010">$</span>(A<span style="color:#960050;background-color:#1e0010">$</span>r7, ((end<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> (start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>mov_rd_rm(A<span style="color:#960050;background-color:#1e0010">$</span>lr, A<span style="color:#960050;background-color:#1e0010">$</span>r7);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>pop_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> A<span style="color:#960050;background-color:#1e0010">$</span>r7);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>blx(A<span style="color:#960050;background-color:#1e0010">$</span>lr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> jump;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>cbz(backup[offset])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> rn : <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> immediate : <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> i : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> op : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            intptr_t jump(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> bits.i <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>            jump <span style="color:#f92672">|=</span> bits.immediate <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//jump &lt;&lt;= 24;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//jump &gt;&gt;= 24;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> rn(bits.rn);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> rt(rn <span style="color:#f92672">==</span> A<span style="color:#960050;background-color:#1e0010">$</span>r7 <span style="color:#f92672">?</span> A<span style="color:#960050;background-color:#1e0010">$</span>r6 : A<span style="color:#960050;background-color:#1e0010">$</span>r7);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>push_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> T1<span style="color:#960050;background-color:#1e0010">$</span>mrs_rd_apsr(rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> T2<span style="color:#960050;background-color:#1e0010">$</span>mrs_rd_apsr(rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>cbz<span style="color:#960050;background-color:#1e0010">$</span>_rn_<span style="color:#960050;background-color:#1e0010">$</span>im(bits.op, rn, (end<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">-</span> (start<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> T1<span style="color:#960050;background-color:#1e0010">$</span>msr_apsr_nzcvqg_rn(rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> T2<span style="color:#960050;background-color:#1e0010">$</span>msr_apsr_nzcvqg_rn(rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>pop_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> jump;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> A<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(A<span style="color:#960050;background-color:#1e0010">$</span>pc, A<span style="color:#960050;background-color:#1e0010">$</span>pc, <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>nop <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span> T<span style="color:#960050;background-color:#1e0010">$</span>bx(A<span style="color:#960050;background-color:#1e0010">$</span>pc);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>nop <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span> T<span style="color:#960050;background-color:#1e0010">$</span>pop_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rt);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>msr_apsr_nzcvqg_rn(rt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if 0</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            if ((start &amp; 0x1) == 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                buffer[start++] = T$nop;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            buffer[start++] = T$bx(A$pc);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            buffer[start++] = T$nop;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            uint32_t *arm(reinterpret_cast&lt;uint32_t *&gt;(buffer + start));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            arm[0] = A$add(A$lr, A$pc, 1);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            arm[1] = A$ldr_rd_$rn_im$(A$pc, A$pc, (trailer - arm) * sizeof(uint32_t) - 8);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>ldrw(backup[offset])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> u : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> immediate : <span style="color:#ae81ff">12</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> rt : <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } exts <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T1<span style="color:#960050;background-color:#1e0010">$</span>ldr_rt_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(exts.rt, A<span style="color:#960050;background-color:#1e0010">$</span>pc, T<span style="color:#960050;background-color:#1e0010">$</span>Label(start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>, end<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> T2<span style="color:#960050;background-color:#1e0010">$</span>ldr_rt_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(exts.rt, A<span style="color:#960050;background-color:#1e0010">$</span>pc, T<span style="color:#960050;background-color:#1e0010">$</span>Label(start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>, end<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> T1<span style="color:#960050;background-color:#1e0010">$</span>ldr_rt_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(exts.rt, exts.rt, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> T2<span style="color:#960050;background-color:#1e0010">$</span>ldr_rt_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(exts.rt, exts.rt, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// XXX: this code &#34;works&#34;, but is &#34;wrong&#34;: the mechanism is more complex than this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span><span style="color:#ae81ff">0x2</span>) <span style="color:#f92672">+</span> (bits.u <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>exts.immediate : exts.immediate);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">++</span>offset;
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span>pcrel<span style="color:#960050;background-color:#1e0010">$</span>add(backup[offset])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">uint16_t</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> rd : <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> rm : <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> h2 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> h1 : <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            } bits <span style="color:#f92672">=</span> {backup[offset<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (bits.h1) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> rt(bits.rd <span style="color:#f92672">==</span> A<span style="color:#960050;background-color:#1e0010">$</span>r7 <span style="color:#f92672">?</span> A<span style="color:#960050;background-color:#1e0010">$</span>r6 : A<span style="color:#960050;background-color:#1e0010">$</span>r7);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>push_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>mov_rd_rm(rt, (bits.h1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">|</span> bits.rd);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>pc_im_4<span style="color:#960050;background-color:#1e0010">$</span>(bits.rd, T<span style="color:#960050;background-color:#1e0010">$</span>Label(start<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, end<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>add_rd_rm((bits.h1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">|</span> bits.rd, rt);
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>pop_r(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> rt);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*--</span>trailer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> offset) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            start <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (T<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">32</span>bit<span style="color:#960050;background-color:#1e0010">$</span>i(backup[offset])) {
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> backup[offset];
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> backup[<span style="color:#f92672">++</span>offset];
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            buffer[start<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> backup[offset];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    buffer[start<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>bx(A<span style="color:#960050;background-color:#1e0010">$</span>pc);
</span></span><span style="display:flex;"><span>    buffer[start<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> T<span style="color:#960050;background-color:#1e0010">$</span>nop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>transfer <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*&gt;</span>(buffer <span style="color:#f92672">+</span> start);
</span></span><span style="display:flex;"><span>    transfer[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> A<span style="color:#960050;background-color:#1e0010">$</span>ldr_rd_<span style="color:#960050;background-color:#1e0010">$</span>rn_im<span style="color:#960050;background-color:#1e0010">$</span>(A<span style="color:#960050;background-color:#1e0010">$</span>pc, A<span style="color:#960050;background-color:#1e0010">$</span>pc, <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    transfer[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">&gt;</span>(area <span style="color:#f92672">+</span> used <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span>setCallOriginalIns(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*&gt;</span>(buffer <span style="color:#f92672">+</span> pad) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="msgetinstructionwiththumb">MSGetInstructionWithThumb</h5>
<p>调用    used += MSGetInstructionWithThumb(reinterpret_cast&lt;uint8_t <em>&gt;(area) + used);
MSGetInstructionWithThumb: 参数为(uint16_t</em>).
返回结果: 为这条指令是多少字节的指令.(4 or 2)</p>
<p>T$32bit$i的作用: (指令(ic) &amp; 1110 0000 0000 0000) &amp;&amp; (ic &amp; 0001 1000 0000 0000 != 0x0000);
第一个判断为确定高位3个bit(即bit[15], bit[14], bit[13])为1. 第二个判断为确保bit[12], bit[11]有值(即至少这两位有 1 位为 1).</p>
<p><code>其实就是判断是该thumb指令是否为thumb32指令, </code>
<code>thumb32指令的判断依据是 b[15:11] 为 0b11101或0b11110或0b11111.</code></p>
<p>MSGetInstructionWithThumb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> size_t <span style="color:#a6e22e">MSGetInstructionWidthThumb</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>start) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span>thumb(<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*&gt;</span>(start));   <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> T<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">32</span>bit<span style="color:#960050;background-color:#1e0010">$</span>i(thumb[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>T$32bit$i:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">bool</span> T<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">32</span>bit<span style="color:#960050;background-color:#1e0010">$</span>i(<span style="color:#66d9ef">uint16_t</span> ic) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ((ic <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xe000</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xe000</span> <span style="color:#f92672">&amp;&amp;</span> (ic <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1800</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x0000</span>);
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h4 id="分析memhelper类">分析MemHelper类</h4>
<p>有4个方法:</p>
<ol>
<li>static bool isFunctionAddr(void* addr);</li>
<li>static bool unProtectMemory(void* addr, uint32_t size);  remove 写保护</li>
<li>static bool protectMemory(void* addr, uint32_t size);    add    写保护</li>
<li>static void* createExecMemory(uint32_t size);            创建一个可执行的内存</li>
</ol>
<p>有4个field:</p>
<ol>
<li>std::vector&lt;void*&gt; all_memory_page;</li>
<li>void* current_page = nullptr;</li>
<li>uint32_t page_ptr  = 0;</li>
<li>static uint32_t page_size;      // 构造函数<code>page_size = sysconf(_SC_PAGESIZE).</code></li>
</ol>
<p>我们现在分析一下<code>createExecMemory(uint32_t size)</code>:</p>
<ol>
<li>可以看到, 分配内存的操作是通过<code>mmap</code>实现的.</li>
<li>all_memory_page是一个vector, 每个单位保存一个指针, 指向mmap的内存.</li>
</ol>
<p>createExecMemory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>FAHook<span style="color:#f92672">::</span>MemHelper<span style="color:#f92672">::</span>createExecMemory(<span style="color:#66d9ef">uint32_t</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(size <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(size <span style="color:#f92672">&gt;</span> page_size) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(gMemHelper.current_page <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span> <span style="color:#f92672">&amp;&amp;</span> page_size <span style="color:#f92672">-</span> gMemHelper.page_ptr_ <span style="color:#f92672">&gt;=</span> size) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">auto</span> funPtr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)((size_t)gMemHelper.current_page <span style="color:#f92672">+</span> gMemHelper.page_ptr_);
</span></span><span style="display:flex;"><span>        gMemHelper.page_ptr_ <span style="color:#f92672">+=</span> size;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Align 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span>(gMemHelper.page_ptr_ <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3</span>) {
</span></span><span style="display:flex;"><span>            gMemHelper.page_ptr_ <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> funPtr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// scroll to next page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> newPage <span style="color:#f92672">=</span> mmap(<span style="color:#66d9ef">nullptr</span>, page_size, PROT_READ <span style="color:#f92672">|</span> PROT_WRITE <span style="color:#f92672">|</span> PROT_EXEC, MAP_ANONYMOUS <span style="color:#f92672">|</span> MAP_PRIVATE, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(newPage <span style="color:#f92672">!=</span> MAP_FAILED) {
</span></span><span style="display:flex;"><span>        gMemHelper.alloc_memory_page_.push_back(newPage);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gMemHelper.current_page <span style="color:#f92672">=</span> newPage;
</span></span><span style="display:flex;"><span>        gMemHelper.page_ptr_ <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">createExecMemory</span>(size);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="分析doinhook">分析doInHook</h4>
<ol>
<li>主要操作: FAInHook::instance()-&gt;hookAll();</li>
<li>FAInHook::instance()-&gt;unHookAll();</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">doInHook</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> isHooked <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isHooked) {
</span></span><span style="display:flex;"><span>        isHooked <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        FAInHook<span style="color:#f92672">::</span>instance()<span style="color:#f92672">-&gt;</span>unhookAll();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        isHooked <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>        FAInHook<span style="color:#f92672">::</span>instance()<span style="color:#f92672">-&gt;</span>hookAll();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>hookAll():</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> FAInHook<span style="color:#f92672">::</span><span style="color:#a6e22e">hookAll</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span> it: hook_map) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(it.second<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHookStatus</span>() <span style="color:#f92672">==</span> FAHook<span style="color:#f92672">::</span>REGISTERED) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Hook</span>(it.second);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>进而转到Hook函数</p>
<ol>
<li>调用`enableJumpStub(info)</li>
<li>info-&gt;setHookStatus(FAHook::HOOKED)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAInHook<span style="color:#f92672">::</span><span style="color:#a6e22e">Hook</span>(FAHook<span style="color:#f92672">::</span>HookInfo <span style="color:#f92672">*</span>info) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>FAHook<span style="color:#f92672">::</span>Instruction<span style="color:#f92672">::</span><span style="color:#a6e22e">enableJumpStub</span>(info)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setHookStatus</span>(FAHook<span style="color:#f92672">::</span>HOOKED);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>分析<code>enableJumpStub(info)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAHook<span style="color:#f92672">::</span>Instruction<span style="color:#f92672">::</span><span style="color:#a6e22e">enableJumpStub</span>(FAHook<span style="color:#f92672">::</span>HookInfo <span style="color:#f92672">*</span>info) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> origAddr <span style="color:#f92672">=</span> <span style="color:#a6e22e">getOriginalAddr</span>(info);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> len <span style="color:#f92672">=</span> info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getJumpStubLen</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> stubAddr <span style="color:#f92672">=</span> info<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getJumpStubBack</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">patchMemory</span>(origAddr, stubAddr, len);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到, 在得到了<code>origAddr</code>和<code>stubAddr</code>和<code>len</code>之后,我们会进入到patch函数<code>patchMemory</code>, 根据我们前面的分析, 它会patch原函数的入口指令的前(8 or 10?)个字节.</p>
<p>patchMemory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> FAHook<span style="color:#f92672">::</span>Instruction<span style="color:#f92672">::</span><span style="color:#a6e22e">patchMemory</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dest, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, <span style="color:#66d9ef">uint32_t</span> len) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(dest <span style="color:#f92672">==</span> nullptr <span style="color:#f92672">||</span> src <span style="color:#f92672">==</span> nullptr <span style="color:#f92672">||</span> len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>MemHelper<span style="color:#f92672">::</span><span style="color:#a6e22e">unProtectMemory</span>(dest, len)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(dest, src, len);
</span></span><span style="display:flex;"><span>    MemHelper<span style="color:#f92672">::</span><span style="color:#a6e22e">protectMemory</span>(dest, len);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef __arm__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cacheflush</span>((Elf_Addr)dest, (Elf_Addr)dest <span style="color:#f92672">+</span> len, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>首先会调用<code>unProtectMemory</code>函数来将对应内存修改为(rwx), 然后调用<code>memcpy</code>来修改内存, 最后调用<code>protectMemory</code>来修改对应内存为(r-x).</p>
<h2 id="总结">总结</h2>
<p>现在我们就基本对该项目进行了简单的分析, 我这里总结一下:</p>
<ol>
<li>
<p>registerHook
主要操作其实就是:</p>
<ul>
<li>createStub:  创建代理(这个代理就是要执行跳转到我们的<code>newFuncAddr</code>函数)</li>
<li>createCallOriginalStub:  call back代理(这个代理就是执行回调, 回调我们的<code>originalFunAddr</code>.) 主要涉及处理pc相关指令(原因在文中已经有介绍).</li>
</ul>
</li>
<li>
<p>doInHook</p>
<ul>
<li>主要就是patchMemory. patch我们originalFunAddr的函数起始处的几个指令为<code>stubInstruction</code>.之后函数涉及pc相关指令的修复, 方便继续执行原函数.</li>
</ul>
</li>
<li>
<p>unHook</p>
<ul>
<li>也是patchMemory.
就是将我们原函数的原始指令进行复原.</li>
</ul>
</li>
</ol></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/hook"><span class="tag">Hook</span></a></li>
        
      </ul>
      
      
      
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">L0phTg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-09-19</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">true</span>
  </p>
</div>
    </footer>
    
      
    
  </section>
  
  

  
  
  
<footer class="site-footer">
  <p>© 2017-2022 L0phTg&#39;s Blog</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>








    
  </body>
</html>
